<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TGP 重新戴上項圈 — 互動敘事地圖</title>
<style>
:root {
  --bg: #0f0f1a;
  --bg2: #161625;
  --bg3: #1e1e32;
  --text: #e8e8f0;
  --text2: #8888a0;
  --text3: #555570;
  --accent: #be185d;
  --accent2: #533483;
  --accent-glow: #be185d22;
  --border: #2a2a42;
  --card: #1a1a2e;
  --card-hover: #1e1e36;
  --tag-bg: rgba(74,153,153,0.15);
  --tag-text: #5db8b8;
  --success: #4ade80;
  --radius: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, 'Noto Sans TC', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  height: 100vh;
  overflow: hidden;
}
.app { display: flex; height: 100vh; flex-direction: column; }

/* === Game Header Banner === */
.game-banner {
  background: linear-gradient(135deg, var(--accent2) 0%, var(--bg3) 50%, var(--bg2) 100%);
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.game-banner::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 300px; height: 100%;
  background: radial-gradient(ellipse at 80% 50%, var(--accent-glow), transparent 70%);
  pointer-events: none;
}
.game-banner h1 {
  font-size: 26px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 1px;
  margin-bottom: 2px;
}
.game-banner .subtitle {
  font-size: 13px;
  color: rgba(255,255,255,0.45);
  font-style: italic;
  margin-bottom: 8px;
}
.game-banner .banner-stats {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: rgba(255,255,255,0.55);
}
.game-banner .banner-stats .stat-item {
  display: flex;
  align-items: center;
  gap: 5px;
}
.game-banner .banner-stats b { color: var(--accent); }
.translation-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}
.translation-badge.full {
  background: rgba(74,222,128,0.15);
  color: var(--success);
}
.translation-badge.partial {
  background: rgba(251,191,36,0.15);
  color: #fbbf24;
}

/* === Toolbar === */
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.search-box {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  width: 220px;
  flex-shrink: 1;
  min-width: 140px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.search-box::placeholder { color: var(--text3); }
.toolbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}
.toggle-row {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
}
.toggle-row input { accent-color: var(--accent); cursor: pointer; }
.toggle-row:hover { color: var(--text); }
.view-toggle { display: flex; gap: 4px; }
.view-btn {
  padding: 5px 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.view-btn:hover { background: var(--bg3); color: var(--text); }
.view-btn.active {
  background: var(--accent2);
  color: #fff;
  border-color: var(--accent2);
  box-shadow: 0 2px 8px rgba(83,52,131,0.3);
}

/* === Content Area === */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 40px;
  scroll-behavior: smooth;
}

/* === Group Headers === */
.group-header {
  width: 100%;
  background: linear-gradient(135deg, var(--accent2), var(--bg3));
  padding: 14px 20px;
  margin: 20px 0 6px 0;
  border-radius: var(--radius);
  position: sticky;
  top: 0;
  z-index: 10;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: transform 0.1s;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.group-header:first-child { margin-top: 0; }
.group-header:active { transform: scale(0.995); }
.group-arrow {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  transition: transform 0.2s;
  flex-shrink: 0;
}
.group-arrow.open { transform: rotate(90deg); }
.group-info { flex: 1; min-width: 0; }
.group-header h2 {
  font-size: 18px;
  font-weight: 600;
  color: #fff;
  margin: 0;
  border: none;
  padding: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.group-header .group-name-en {
  font-size: 11px;
  color: rgba(255,255,255,0.35);
  font-style: italic;
  margin-top: 1px;
}
.group-header .group-stats {
  font-size: 12px;
  color: rgba(255,255,255,0.45);
  flex-shrink: 0;
}
.group-header .group-stats b { color: var(--accent); }

/* === Group Body === */
.group-body {
  display: none;
  padding: 2px 0;
}
.group-body.open { display: block; }

/* === Passage Cards === */
.passage {
  background: var(--card);
  padding: 14px 18px;
  margin: 5px 0;
  border-radius: 8px;
  border-left: 3px solid transparent;
  transition: border-color 0.2s, background 0.15s;
  position: relative;
}
.passage:hover {
  border-left-color: var(--accent);
  background: var(--card-hover);
}
.passage-header {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 6px;
}
.passage-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.passage .pid {
  font-size: 10px;
  color: var(--text3);
  font-family: 'Consolas', monospace;
  flex-shrink: 0;
}
.passage .pname {
  font-size: 11px;
  color: var(--tag-text);
  margin-bottom: 4px;
  font-family: monospace;
}
.passage .text {
  font-size: 14.5px;
  line-height: 1.85;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
}
.passage-img {
  max-width: 100%;
  max-height: 400px;
  border-radius: 8px;
  margin: 8px 0;
  display: block;
}
.passage .text-en {
  font-size: 12px;
  color: var(--text2);
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed var(--border);
  font-style: italic;
  line-height: 1.6;
  white-space: pre-wrap;
  max-height: 150px;
  overflow: hidden;
  position: relative;
}
.passage .text-en.collapsed::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(transparent, var(--card));
  pointer-events: none;
}
.passage .tag-row { margin-bottom: 6px; }
.passage .tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--tag-bg);
  color: var(--tag-text);
  font-size: 11px;
  margin-right: 4px;
  margin-bottom: 2px;
}
.passage-num {
  font-size: 10px;
  color: var(--text3);
  font-family: monospace;
  position: absolute;
  top: 14px;
  right: 16px;
}

/* === Empty / Loading States === */
.loading {
  text-align: center;
  padding: 80px 20px;
  color: var(--text2);
}
.loading .spinner {
  display: inline-block;
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text2);
  font-size: 14px;
}

/* === Scrollbar === */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent2); }

/* === Mobile === */
@media (max-width: 768px) {
  .game-banner { padding: 16px; }
  .game-banner h1 { font-size: 22px; }
  .content { padding: 12px; }
  .passage .text { font-size: 15px; line-height: 1.9; }
  .toolbar { padding: 6px 10px; gap: 6px; }
  .search-box { width: 100%; }
  .toolbar-right { margin-left: 0; width: 100%; flex-wrap: wrap; justify-content: center; }
  .view-toggle { width: 100%; justify-content: center; }
  .group-header { padding: 12px 14px; }
  .group-header h2 { font-size: 16px; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Game Banner -->
  <div class="game-banner">
    <h1 id="gameTitle">載入中...</h1>
    <div class="subtitle" id="gameSubtitle"></div>
    <div class="banner-stats" id="bannerStats"></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <input type="text" class="search-box" id="searchBox" placeholder="搜尋段落內容...">
    <div class="toolbar-right">
      <label class="toggle-row">
        <input type="checkbox" id="showZh" checked>
        <span>中文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showEn">
        <span>英文原文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showName">
        <span>段落 ID</span>
      </label>
      <div class="view-toggle">
        <button class="view-btn active" data-view="group" id="viewGroup">按分類</button>
        <button class="view-btn" data-view="all" id="viewAll">全部段落</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="loading">
      <div class="spinner"></div>
      <div>載入敘事數據中...</div>
    </div>
  </div>
</div>

<script>
// === Config (injected by build script) ===
const GAME_CONFIG = {"title": "TGP Recollared", "title_zh": "TGP 重新戴上項圈", "color_accent": "#be185d", "engine": ""};

// === State ===
let DATA = null;
let searchQuery = '';
let showZh = true;
let showEn = false;
let showName = false;
let currentView = 'group';
let openGroups = new Set();

// === Data Loading ===
async function loadData() {
  const resp = await fetch('data/passages.json?v=' + Date.now());
  DATA = await resp.json();
  if (!DATA.meta.has_zh) {
    document.getElementById('showZh').parentElement.style.display = 'none';
    showZh = false;
    showEn = true;
    document.getElementById('showEn').checked = true;
  }
  init();
}

// === Banner ===
function renderBanner() {
  const m = DATA.meta;
  const titleZh = m.title_zh || m.title || '';
  const titleEn = m.title || '';
  document.getElementById('gameTitle').textContent = titleZh;
  document.getElementById('gameSubtitle').textContent = titleZh !== titleEn ? titleEn : '';
  document.title = titleZh + ' — 互動敘事地圖';

  const total = m.total || DATA.passages.length;
  const zhCount = m.translated_count || DATA.passages.filter(p => p.content_zh).length;
  const groupCount = (DATA.groups || []).length;
  const pct = total > 0 ? Math.round(zhCount / total * 100) : 0;

  let badgeClass = pct >= 95 ? 'full' : 'partial';
  let badgeText = pct >= 95 ? '✓ 翻譯完成' : `${pct}% 已翻譯`;

  document.getElementById('bannerStats').innerHTML = `
    <span class="stat-item"><b>${groupCount}</b> 分類</span>
    <span class="stat-item"><b>${total}</b> 段落</span>
    <span class="translation-badge ${badgeClass}">${badgeText}</span>
  `;
}

// === Filtering ===
function getFiltered() {
  let passages = DATA.passages;
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.content_zh || '').toLowerCase().includes(q) ||
      (p.content || '').toLowerCase().includes(q) ||
      (p.name || '').toLowerCase().includes(q) ||
      (p.group || '').toLowerCase().includes(q) ||
      (p.group_zh || '').includes(q)
    );
  }
  return passages;
}

// === Auto Title ===
function getPassageTitle(p) {
  // If passage has a meaningful title (not just an ID like "g7" or "passage_12")
  const name = p.name || '';
  if (name && !/^(g\d|passage_|p\d|#|\d+$)/.test(name) && name.length > 2 && name.length < 80) {
    return name;
  }
  // Extract first sentence from Chinese content
  if (p.content_zh) {
    const first = p.content_zh.split(/[。！？\n]/)[0];
    if (first && first.length > 4) {
      return first.length > 60 ? first.substring(0, 57) + '...' : first;
    }
  }
  // Extract from English content
  if (p.content) {
    const first = p.content.split(/[.!?\n]/)[0];
    if (first && first.length > 4) {
      return first.length > 60 ? first.substring(0, 57) + '...' : first;
    }
  }
  return name || `段落 ${p.pid}`;
}

// === Passage HTML ===
function passageHtml(p, idx) {
  const title = getPassageTitle(p);
  const pid = p.pid != null ? `<span class="pid">#${p.pid}</span>` : '';
  const pname = showName && p.name ? `<div class="pname">${escHtml(p.name)}</div>` : '';
  const tags = (p.tags && p.tags.length > 0)
    ? `<div class="tag-row">${p.tags.map(t => `<span class="tag">${escHtml(t)}</span>`).join('')}</div>`
    : '';

  let textHtml = '';
  if (showZh && p.content_zh) {
    textHtml += `<div class="text">${formatText(p.content_zh)}</div>`;
  }
  if (showEn && p.content) {
    if (showZh && p.content_zh) {
      const isLong = p.content.length > 300;
      textHtml += `<div class="text-en${isLong ? ' collapsed' : ''}">${formatText(p.content)}</div>`;
    } else {
      textHtml += `<div class="text">${formatText(p.content)}</div>`;
    }
  }
  if (!textHtml) {
    if (p.content_zh) {
      textHtml = `<div class="text">${formatText(p.content_zh)}</div>`;
    } else if (p.content) {
      textHtml = `<div class="text">${formatText(p.content)}</div>`;
    } else {
      textHtml = `<div class="text" style="color:var(--text3)">（無內容）</div>`;
    }
  }

  return `<div class="passage">
    <div class="passage-header">
      <span class="passage-title">${escHtml(title)}</span>
      ${pid}
    </div>
    ${pname}${tags}${textHtml}
  </div>`;
}

function formatText(s) {
  if (!s) return '';
  // Extract <img> tags before escaping, replace with placeholders
  const imgs = [];
  let safe = s.replace(/<img\s[^>]*>/gi, m => {
    const i = imgs.length;
    // Ensure class and lazy loading
    let tag = m;
    if (!/class=/.test(tag)) tag = tag.replace('<img', '<img class="passage-img"');
    if (!/loading=/.test(tag)) tag = tag.replace('<img', '<img loading="lazy"');
    imgs.push(tag);
    return ' IMG' + i + ' ';
  });
  // Escape remaining HTML
  let html = escHtml(safe);
  // Restore <img> tags from placeholders
  html = html.replace(/ IMG(\d+) /g, (_, i) => imgs[+i]);
  // Convert ![img](url) markdown syntax
  html = html.replace(/!\[img\]\(([^)]+)\)/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  // Convert Twine [img[path]] and [img[path][link]] syntax
  html = html.replace(/\[img\[([^\]]+?)\](?:\[[^\]]*\])?\]/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  // Convert [image: path] syntax
  html = html.replace(/\[image:\s*\.?\/?([^\]]+)\]/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  // Convert double newlines to paragraph breaks, single to <br>
  html = html.replace(/

+/g, '</p><p>').replace(/
/g, '<br>');
  return '<p>' + html + '</p>';
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// === Group View ===
function renderGroupView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  const groups = groupPassages(passages);

  if (groups.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  let total = 0;
  groups.forEach(([gName, gPassages]) => {
    total += gPassages.length;
    const isOpen = openGroups.has(gName);

    // Find group info
    const gInfo = (DATA.groups || []).find(g => g.id === gName);
    const displayName = gInfo ? (gInfo.name_zh || gInfo.name || gName) : gName;
    const displayNameEn = gInfo && gInfo.name_zh && gInfo.name !== gInfo.name_zh ? gInfo.name : '';

    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `
      <span class="group-arrow${isOpen ? ' open' : ''}">▶</span>
      <div class="group-info">
        <h2>${escHtml(displayName)}</h2>
        ${displayNameEn ? `<div class="group-name-en">${escHtml(displayNameEn)}</div>` : ''}
      </div>
      <div class="group-stats"><b>${gPassages.length}</b> 段落</div>
    `;

    const body = document.createElement('div');
    body.className = 'group-body' + (isOpen ? ' open' : '');

    header.addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      header.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openGroups.add(gName);
        if (!body.dataset.rendered) {
          renderPassageChunked(body, gPassages, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openGroups.delete(gName);
      }
    });

    // Auto-render if was open
    if (isOpen && !body.dataset.rendered) {
      renderPassageChunked(body, gPassages, 0);
      body.dataset.rendered = '1';
    }

    content.appendChild(header);
    content.appendChild(body);
  });
}

// === Grouping (respects DATA.groups order from JSON) ===
function groupPassages(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const g = p.group || '（未分類）';
    if (!groups.has(g)) groups.set(g, []);
    groups.get(g).push(p);
  });
  // Use DATA.groups order if available, otherwise fallback to count-based sort
  if (DATA.groups && DATA.groups.length > 0) {
    const ordered = [];
    const seen = new Set();
    DATA.groups.forEach(gi => {
      const key = gi.id || gi.name;
      if (groups.has(key)) {
        ordered.push([key, groups.get(key)]);
        seen.add(key);
      }
    });
    // Append any groups not in DATA.groups
    groups.forEach((v, k) => { if (!seen.has(k)) ordered.push([k, v]); });
    return ordered;
  }
  return Array.from(groups.entries()).sort((a, b) => b[1].length - a[1].length);
}

// === All View ===
function renderAllView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  if (passages.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }
  renderPassageChunked(content, passages, 0);
}

// === Chunked Rendering ===
function renderPassageChunked(container, passages, startIdx) {
  const CHUNK = 80;
  const end = Math.min(startIdx + CHUNK, passages.length);
  let html = '';
  for (let i = startIdx; i < end; i++) {
    html += passageHtml(passages[i], i);
  }
  container.insertAdjacentHTML('beforeend', html);

  if (end < passages.length) {
    const sentinel = document.createElement('div');
    sentinel.className = 'loading';
    sentinel.style.padding = '20px';
    sentinel.innerHTML = `<div style="font-size:12px;color:var(--text3)">載入更多 (${end}/${passages.length})...</div>`;
    container.appendChild(sentinel);

    const obs = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        obs.disconnect();
        sentinel.remove();
        renderPassageChunked(container, passages, end);
      }
    });
    obs.observe(sentinel);
  }
}

// === Render ===
function resetAndRender() {
  const passages = getFiltered();
  if (currentView === 'group') {
    renderGroupView(passages);
  } else {
    renderAllView(passages);
  }
}

function setActiveView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(view === 'group' ? 'viewGroup' : 'viewAll').classList.add('active');
  resetAndRender();
}

// === Init ===
function init() {
  renderBanner();

  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      resetAndRender();
    }, 300);
  });

  document.getElementById('showZh').addEventListener('change', (e) => {
    showZh = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showEn').addEventListener('change', (e) => {
    showEn = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showName').addEventListener('change', (e) => {
    showName = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });

  document.getElementById('viewGroup').addEventListener('click', () => setActiveView('group'));
  document.getElementById('viewAll').addEventListener('click', () => setActiveView('all'));

  resetAndRender();
}

function clearRenderedCache() {
  openGroups.clear();
  document.querySelectorAll('.group-body').forEach(div => {
    div.dataset.rendered = '';
  });
}

loadData();
</script>
</body>
</html>
